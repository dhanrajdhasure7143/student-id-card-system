<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Student Result Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <style>
        body {
            background: linear-gradient(to right, #83a4d4, #b6fbff);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card {
            width: 100%;
            /* max-width: 700px; */
        }

        .table thead {
            background-color: #0d6efd;
            color: white;
        }
    </style>
</head>

<body>

    <div class="container my-5">
        <div class="card shadow">
            <div class="card-body">
                <h3 class="text-center text-primary mb-4">Student Result Portal</h3>

                <div class="mb-3 text-center">
                    <input type="text" id="regNoInput" class="form-control form-control-lg"
                        placeholder="Enter Registration Number" />
                </div>

                <div class="d-grid gap-2 col-6 mx-auto mb-4">
                    <button class="btn btn-primary btn-lg" onclick="fetchResult()">Get Result</button>
                </div>

                <div id="resultContainer"></div>
            </div>
        </div>
    </div>

    <!-- Firebase Script -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBA1pXFMudNDCpEI7UHtnSpzhmjJd4XNyY",
            authDomain: "student-id-app-4c8d9.firebaseapp.com",
            projectId: "student-id-app-4c8d9",
            storageBucket: "student-id-app-4c8d9.appspot.com",
            messagingSenderId: "59330959442",
            appId: "1:59330959442:web:505a4774f6ee02014ae78b"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function fetchResult() {
            const regNo = document.getElementById("regNoInput").value.trim();
            const resultContainer = document.getElementById("resultContainer");
            resultContainer.innerHTML = "";

            if (!regNo) {
                resultContainer.innerHTML = `<div class="alert alert-danger text-center">Please enter a registration number.</div>`;
                return;
            }

            db.collection("results")
                .where("regNo", "==", regNo)
                .orderBy("timestamp", "desc")
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        resultContainer.innerHTML = `<div class="alert alert-warning text-center">No result found for Reg No <strong>${regNo}</strong>.</div>`;
                        return;
                    }

                    let allResultsHTML = '';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        allResultsHTML += `
                        <h5 class="mt-4">${data.course} - Semester ${data.semester}</h5>
                        ${createResultsTable(data.subjects)}
                        <hr>
                    `;
                    });

                    resultContainer.innerHTML = allResultsHTML;
                })
                .catch(err => {
                    resultContainer.innerHTML = `<div class="alert alert-danger text-center">Error: ${err.message}</div>`;
                });
        }

        function getGrade(obt, total) {
            const p = (obt / total) * 100;
            if (p >= 90) return 'A+';
            if (p >= 75) return 'A';
            if (p >= 60) return 'B';
            if (p >= 50) return 'C';
            if (p >= 35) return 'D';
            return 'F';
        }

        function createResultsTable(subjects) {
            let tTotal = 0, pTotal = 0, tObt = 0, pObt = 0;
            let rows = subjects.map(sub => {
                const tt = sub.totalTheoryMarks || 0;
                const tp = sub.totalPracticalMarks || 0;
                const ot = sub.obtainedTheory || 0;
                const op = sub.obtainedPractical || 0;
                const total = ot + op;
                const grade = getGrade(total, tt + tp);

                tTotal += tt;
                pTotal += tp;
                tObt += ot;
                pObt += op;

                return `
          <tr>
            <td>${sub.subjectCode || '-'}</td>
            <td>${sub.subject}</td>
            <td>${tt}</td>
            <td>${tp}</td>
            <td>${ot}</td>
            <td>${op}</td>
            <td>${total}</td>
            <td>${grade}</td>
          </tr>`;
            }).join('');

            const totalMarks = tTotal + pTotal;
            const totalObtained = tObt + pObt;
            const percentage = ((totalObtained / (totalMarks || 1)) * 100).toFixed(2);

            rows += `
        <tr class="fw-bold table-success">
          <td colspan="2">Total</td>
          <td>${tTotal}</td>
          <td>${pTotal}</td>
          <td>${tObt}</td>
          <td>${pObt}</td>
          <td>${totalObtained}</td>
          <td>${percentage}%</td>
        </tr>`;

            return `<div class="table-responsive">
        <table class="table table-bordered table-striped mt-3">
          <thead>
            <tr>
              <th>Sub Code</th>
              <th>Subject</th>
              <th>Total Theory</th>
              <th>Total Practical</th>
              <th>Obt. Theory</th>
              <th>Obt. Practical</th>
              <th>Total Obt.</th>
              <th>Grade</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
        }
    </script>


</body>

</html>